{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âlections AESP - South Polytech</title>
    <style>
        /* --- Styles G√©n√©raux --- */
        :root {
            --primary-color: #24284B; /* Bleu fonc√© Polytech */
            --secondary-color: #E87722; /* Orange Polytech */
            --light-gray: #f4f4f4;
            --dark-gray: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
            --pending-color: #ffc107;
        }

        @import url('https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap');
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
            overflow: hidden;
        }

        header {
            background: var(--primary-color);
            color: #fff;
            padding: 0 0;
            text-align: center;
            border: 5px solid var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-right: 0rem;
            background: #fff;
        }

        .logo {
            height: 100px;
            width: auto;
        }

        header h1 {
            margin-bottom: 0.5rem;
            margin-bottom: 0;
        }

        main {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }

        footer {
            text-align: center;
            padding: 1rem;
            background: var(--dark-gray);
            color: #fff;
            position: relative;
            bottom: 0;
            width: 100%;
            margin-top: 2rem;
        }

        /* --- Vues de l'application --- */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* --- Styles pour les Loaders --- */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loader-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            min-width: 200px;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loader-text {
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* D√©sactiver les boutons pendant le loading */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Styles des formulaires et boutons --- */
        .form-container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 1rem auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group input[type="file"] {
            padding: 0.5rem;
        }

        .file-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .btn {
            display: inline-block;
            background: var(--secondary-color);
            color: #fff;
            padding: 0.8rem 1.5rem;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background: #d46a1e;
        }

        .btn-primary {
            background: var(--primary-color);
        }
        .btn-primary:hover {
            background: #002244;
        }

        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--error-color); }
        .btn-warning { background: var(--pending-color); }
        .btn-block {
            display: block;
            width: 100%;
        }

        .toggle-link {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 1rem;
            display: inline-block;
        }

        /* --- Styles des Tableaux de Bord --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .dashboard-header h2 {
            color: var(--primary-color);
        }

        .card {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* --- Interface Admin --- */
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .admin-nav .btn {
            flex-grow: 1;
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        /* Style pour le bouton actif */
        .admin-nav .btn.active {
            background: var(--secondary-color);
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(232, 119, 34, 0.3);
            transform: translateY(-2px);
        }

        /* Effet de surbrillance pour le bouton actif */
        .admin-nav .btn.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* Effet de hover pour les boutons non actifs */
        .admin-nav .btn:not(.active):hover {
            background: #d46a1e;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .admin-content {
            display: none;
        }
        .admin-content.active {
            display: block;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .list-item:nth-child(even) {
            background: var(--light-gray);
        }

        .status-pending {
            color: var(--pending-color);
            font-weight: bold;
        }
        .status-validated {
            color: var(--success-color);
            font-weight: bold;
        }

        /* --- Badges de Bureau pour les Candidats --- */
        .bureau-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* Ic√¥nes pour les badges */
        .bureau-badge i {
            margin-right: 4px;
            font-size: 0.6rem;
        }
        
        /* Ajustement pour le badge de s√©lection quand il y a un badge de bureau */
        .candidate-card:has(.bureau-badge) .selection-badge {
            top: 10px;
            right: 10px;
        }
        
        /* Style pour l'aper√ßu de couleur dans le formulaire */
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #ddd;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        /* --- Interface de Vote AM√âLIOR√âE --- */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .candidate-card {
            text-align: center;
            background: #fff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            max-width: 100%; /* Emp√™che le d√©bordement horizontal */
            word-wrap: break-word; /* Force le retour √† la ligne */
        }
        
        .candidate-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }
        
        .candidate-card.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #fff, #f8fff8);
        }
        
        .candidate-card img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .candidate-card.selected img {
            border-color: var(--success-color);
            transform: scale(1.05);
        }
        
        .candidate-card h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-size: 1.3rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto; /* C√©sure des mots longs */
        }
        
        /* CORRECTION PLEINE LARGEUR POUR LES INFORMATIONS */
        .candidate-info {
            text-align: left;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
            font-size: 0.9rem;
            width: 100%; /* Prend toute la largeur */
            box-sizing: border-box; /* Inclut le padding dans la largeur */
        }
        
        .candidate-info p {
            margin: 0.3rem 0;
            display: flex;
            align-items: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0; /* Permet au flex de bien fonctionner */
        }
        
        .candidate-info i {
            margin-right: 0.5rem;
            color: var(--secondary-color);
            width: 16px;
            flex-shrink: 0; /* Emp√™che l'ic√¥ne de r√©tr√©cir */
        }
        
        /* Style pour le texte des informations */
        .candidate-info strong {
            flex-shrink: 0; /* Emp√™che le label de r√©tr√©cir */
            margin-right: 0.3rem;
        }
        
        .candidate-info span {
            flex: 1; /* Prend l'espace restant */
            min-width: 0; /* Permet au texte de se casser */
            word-break: break-word; /* Force la c√©sure des mots longs */
        }
        
        /* CORRECTION PLEINE LARGEUR POUR LE SLOGAN */
        .slogan {
            font-style: italic;
            color: var(--secondary-color);
            margin: 1rem 0;
            padding: 0.8rem;
            background: linear-gradient(135deg, #fff3e0, #ffecb3);
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
            width: 100%; /* Prend toute la largeur */
            box-sizing: border-box; /* Inclut le padding dans la largeur */
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .vote-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            width: 100%;
            box-sizing: border-box; /* Important pour la largeur 100% */
        }
        
        .vote-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }
        
        .vote-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .selection-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            display: none;
        }
        
        .candidate-card.selected .selection-badge {
            display: block;
        }

        .vote-instructions {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .vote-instructions h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        /* Styles pour les boutons de contr√¥le d'√©lection */
        #electionControlButtons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        #electionControlButtons .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            font-weight: 500;
        }
        
        /* Style sp√©cifique pour le bouton de r√©initialisation */
        .btn-warning {
            background: var(--pending-color);
            border: none;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            color: #000;
        }
        
        /* Section des statistiques */
        #electionStats {
            border-left: 4px solid var(--primary-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        /* --- Formulaire d'ajout de candidat am√©lior√© --- */
        .candidate-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .candidate-form-grid .form-group {
            margin-bottom: 0;
        }

        /* --- R√©sultats --- */
        .result-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 5px 0 15px 0;
        }

        .result-bar {
            height: 25px;
            background-color: var(--success-color);
            border-radius: 4px;
            text-align: right;
            padding-right: 5px;
            line-height: 25px;
            color: white;
            transition: width 0.5s ease-in-out;
        }

        /* --- Styles pour les messages de confirmation --- */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .confirmation-success {
            border: 3px solid var(--success-color);
        }

        .confirmation-error {
            border: 3px solid var(--error-color);
        }

        .confirmation-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .confirmation-success .confirmation-title {
            color: var(--success-color);
        }

        .confirmation-error .confirmation-title {
            color: var(--error-color);
        }

        .confirmation-message {
            color: #333;
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirmation-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .confirmation-button:hover {
            background: #002244;
        }

        /* --- Utilitaires --- */
        .text-center {
            text-align: center;
        }
        .message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        .message-success { background-color: #d4edda; color: #155724; }
        .message-error { background-color: #f8d7da; color: #721c24; }
        .message-info { background-color: #cce5ff; color: #004085; }
        .message-warning { background-color: #fff3cd; color: #856404; }

        /* --- Responsive Design --- */
        @media (max-width: 854px) {
            .logo {
                height: 54px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 22px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 10px;
            }

        }
        @media (max-width: 580px) {
            .logo {
                height: 50px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 18px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 10px;
            }
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .list-item > div:last-child {
                width: 100%;
                margin-top: 0.5rem;
            }
            .list-item .btn {
                width: 100%;
            }
            .admin-nav {
                flex-direction: column;
            }
            .candidates-grid {
                grid-template-columns: 1fr;
            }
            .candidate-form-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 492px) {
            .logo {
                height: 47px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 16px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 10px;
            }
            
            .candidates-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .candidate-card {
                padding: 1rem;
                margin: 0 0.5rem;
            }
            
            .candidate-card img {
                width: 120px;
                height: 120px;
            }
            
            .candidate-card h4 {
                font-size: 1.1rem;
            }
            
            .candidate-info {
                padding: 0.8rem;
                font-size: 0.85rem;
            }
            
            .candidate-info p {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
            .candidate-info i {
                margin-bottom: 0.2rem;
            }
            
            .slogan {
                padding: 0.6rem;
                font-size: 0.9rem;
            }

        }
        @media (max-width: 447px) {
            .logo {
                height: 54px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 13px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 10px;
            }
            footer p {
                font-size: 12px;
            }

        }
        @media (max-width: 401px) {
            .logo {
                height: 45px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 11px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 8px;
            }

        }
        @media (max-width: 347px) {
            .logo {
                height: 34px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 11px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 8px;
            }
            footer p {
                font-size: 10px;
            }

        }
        @media (max-width: 326px) {
            .logo {
                height: 30px;
                width: auto;
            }

            header h1 {
                margin-bottom: 0.5rem;
                font-size: 10px;
                margin-bottom: 0;
            }
            header p {
                margin-bottom: 0.5rem;
                font-size: 8px;
            }

        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Loaders pour les diff√©rentes op√©rations -->
    <div id="globalLoader" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Chargement...</p>
        </div>
    </div>
    
    <div id="pageLoadLoader" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Chargement de l'application...</p>
        </div>
    </div>
    
    <div id="loginLoader" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Connexion en cours...</p>
        </div>
    </div>
    
    <div id="registerLoader" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Inscription en cours...</p>
        </div>
    </div>
    
    <div id="voteLoader" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Enregistrement de votre vote...</p>
        </div>
    </div>

    <div id="registerCandidat" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Enregistrement du candidat...</p>
        </div>
    </div>
    <div id="deleteCandidat" class="loader-overlay" style="display: none;">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Supression du candidat...</p>
        </div>
    </div>

    <header>
        <div class="logo-container">
            <img src="{% static 'vote_app/images/AESP.png' %}" alt="Logo AESP" class="logo">
        </div>
        <div class="container">
            <h1>√âlections du Bureau de l'AESP 2025/2026</h1>
            <p>Association des √âtudiants de South Polytech</p>
        </div>
        <div class="logo-container">
            <img src="{% static 'vote_app/images/SP.png' %}" alt="Logo SP" class="logo">
        </div>
    </header>

    <main class="container">
        <!-- Bo√Ætes de confirmation -->
        <div id="successConfirmation" class="confirmation-overlay">
            <div class="confirmation-box confirmation-success">
                <div class="confirmation-title">‚úÖ Inscription R√©ussie !</div>
                <div class="confirmation-message">
                    Votre inscription a √©t√© enregistr√©e avec succ√®s.<br>
                    Votre compte est en attente de validation par un administrateur.
                </div>
                <button class="confirmation-button" onclick="hideConfirmation('success')">OK</button>
            </div>
        </div>

        <div id="errorConfirmation" class="confirmation-overlay">
            <div class="confirmation-box confirmation-error">
                <div class="confirmation-title">‚ùå Erreur d'Inscription</div>
                <div class="confirmation-message" id="errorMessage">
                    Une erreur est survenue lors de l'inscription.
                </div>
                <button class="confirmation-button" onclick="hideConfirmation('error')">OK</button>
            </div>
        </div>

        <!-- Vue de Connexion / Inscription -->
        <div id="authView" class="view active">
            <div class="logo-container text-center" style="justify-content: center; margin-bottom: 1rem;">
                <img src="{% static 'vote_app/images/AESP.png' %}" alt="Logo AESP" class="logo">
            </div>
            <div id="loginFormContainer" class="form-container">
                <h2>Connexion</h2>
                <form id="loginForm">
                    <div id="loginError" class="message message-error" style="display: none;"></div>
                    <div class="form-group">
                        <label for="loginMatricule">Matricule</label>
                        <input type="text" id="loginMatricule" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Mot de passe</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Se connecter</button>
                </form>
                <p class="text-center">Pas encore de compte ? <span id="showRegister" class="toggle-link">S'inscrire</span></p>
            </div>

            <div id="registerFormContainer" class="form-container" style="display: none;">
                <h2>Inscription √âtudiant</h2>
                <form id="registerForm">
                    <div id="registerError" class="message message-error" style="display: none;"></div>
                    <div id="registerSuccess" class="message message-success" style="display: none;"></div>
                    <div class="form-group">
                        <label for="registerNom">Nom</label>
                        <input type="text" id="registerNom" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPrenom">Pr√©nom</label>
                        <input type="text" id="registerPrenom" required>
                    </div>
                    <div class="form-group">
                        <label for="registerMatricule">Matricule scolaire</label>
                        <input type="text" id="registerMatricule" required>
                    </div>
                    <div class="form-group">
                        <label for="registerCycle">Cycle</label>
                        <select id="registerCycle" required>
                            <option value="">S√©lectionnez votre cycle</option>
                            <option value="bts">BTS</option>
                            <option value="licence">Licence</option>
                            <option value="master">Master</option>
                            <option value="ingenieur">Ing√©nieur</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="registerSpecialite">Sp√©cialit√©</label>
                        <select id="registerSpecialite" required disabled>
                            <option value="">S√©lectionnez d'abord le cycle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="registerNiveau">Niveau</label>
                        <select id="registerNiveau" required disabled>
                            <option value="">S√©lectionnez d'abord le cycle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Mot de passe</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirmer le mot de passe</label>
                        <input type="password" id="registerConfirmPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPhoto">Photo de profil</label>
                        <input type="file" id="registerPhoto" accept="image/*" required>
                        <img id="photoPreview" class="file-preview">
                    </div>
                    <div class="form-group">
                        <label for="registerRecu">Photo du re√ßu de paiement des frais d'inscription</label>
                        <input type="file" id="registerRecu" accept="image/*" required>
                        <img id="recuPreview" class="file-preview">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">S'inscrire</button>
                </form>
                <p class="text-center">D√©j√† un compte ? <span id="showLogin" class="toggle-link">Se connecter</span></p>
            </div>
        </div>

        <!-- Vue √âtudiant - En attente de validation -->
        <div id="studentPendingView" class="view">
            <div class="card text-center">
                <h2>Bienvenue !</h2>
                <div class="message message-warning">
                    <p>Votre inscription est en attente de validation par un administrateur.</p>
                    <p>Veuillez patienter. Vous serez notifi√© lorsque votre compte sera activ√©.</p>
                </div>
                <button id="logoutBtnPending" class="btn">Se d√©connecter</button>
            </div>
        </div>

        <!-- Vue √âtudiant - Vote AM√âLIOR√âE -->
        <div id="studentVoteView" class="view">
            <div class="dashboard-header">
                <h2 id="studentWelcomeMsg"></h2>
                <button id="logoutBtnVote" class="btn">Se d√©connecter</button>
            </div>
            
            <div class="vote-instructions">
                <h3><i class="fas fa-vote-yea"></i> √âlection du Bureau de l'AESP 2025/2026</h3>
                <p>Choisissez votre candidat pr√©f√©r√© en cliquant sur sa carte. Vous ne pourrez voter qu'une seule fois !</p>
            </div>

            <div class="card">
                <h3><i class="fas fa-users"></i> Liste des Candidats</h3>
                <div id="electionStatusMessage"></div>
                <div id="selectedCandidateInfo" class="message message-info" style="display: none; text-align: center;">
                    <strong>Candidat s√©lectionn√© : </strong><span id="selectedCandidateName"></span>
                    <button id="confirmVoteBtn" class="btn btn-success" style="margin-left: 1rem;">
                        <i class="fas fa-check"></i> Confirmer mon vote
                    </button>
                </div>
                <div id="candidatesForVote" class="candidates-grid">
                    <!-- Les candidats seront inject√©s ici par JS -->
                </div>
            </div>
        </div>
        
        <!-- Vue √âtudiant - A d√©j√† vot√© -->
        <div id="studentVotedView" class="view">
            <div class="card text-center">
                <h2 id="studentWelcomeVotingMsg"> </h2>
                <div class="message message-success">
                    <p>Votre voix a √©t√© enregistr√©e avec succ√®s.</p>
                    <p>Les r√©sultats seront annonc√©s √† la fin de la p√©riode de vote.</p>
                </div>
                <button id="logoutBtnVoted" class="btn">Se d√©connecter</button>
            </div>
        </div>

        <!-- Vue Administrateur AM√âLIOR√âE -->
        <div id="adminDashboardView" class="view">
            <div class="dashboard-header">
                <h2>Tableau de Bord Administrateur</h2>
                <button id="logoutBtnAdmin" class="btn">Se d√©connecter</button>
            </div>
            
            <nav class="admin-nav">
                <button class="btn btn-primary admin-nav-btn" data-target="validationContent">Validation des Inscriptions</button>
                <button class="btn btn-primary admin-nav-btn" data-target="usersContent">Gestion des √âtudiants</button>
                <button class="btn btn-primary admin-nav-btn" data-target="candidatesContent">Gestion des Candidats</button>
                <button class="btn btn-primary admin-nav-btn" data-target="electionContent">Gestion de l'√âlection</button>
                <button class="btn btn-primary admin-nav-btn" data-target="resultsContent">Voir les R√©sultats</button>
            </nav>

            <!-- Contenu Admin: Validation -->
            <div id="validationContent" class="admin-content card">
                <h3>√âtudiants en attente de validation</h3>
                <div id="pendingUsersList"></div>
            </div>

            <!-- Contenu Admin: Gestion des candidats AM√âLIOR√âE -->
            <div id="candidatesContent" class="admin-content card">
                <h3><i class="fas fa-user-plus"></i> Ajouter un candidat</h3>
                <form id="addCandidateForm">
                    <div class="candidate-form-grid">
                        <div class="form-group">
                            <label for="candidateNom">Nom</label>
                            <input type="text" id="candidateNom" required>
                        </div>
                        <div class="form-group">
                            <label for="candidatePrenom">Pr√©nom</label>
                            <input type="text" id="candidatePrenom" required>
                        </div>
                    </div>
                    <div class="candidate-form-grid">
                        <div class="form-group">
                            <label for="candidateCycle">cycle</label>
                            <select id="candidateCycle" required>
                                <option value="">S√©lectionnez le cycle</option>
                                <option value="bts">BTS</option>
                                <option value="licence">Licence</option>
                                <option value="master">Master</option>
                                <option value="ingenieur">Ing√©nieur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="candidateSpecialite">Sp√©cialit√©</label>
                            <select id="candidateSpecialite" required disabled>
                                <option value="">S√©lectionnez d'abord le cycle</option>
                            </select>
                        </div>
                    </div>
                    <div class="candidate-form-grid"> 
                        <div class="form-group">
                            <label for="candidateNiveau">Niveau</label>
                            <select id="candidateNiveau" required disabled>
                                <option value="">S√©lectionnez d'abord le cycle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="candidateSlogan">Slogan de campagne</label>
                            <input type="text" id="candidateSlogan" required placeholder="Ex: L'avenir ensemble !">
                        </div>
                    </div>
                    <div class="candidate-form-grid">
                        <div class="form-group">
                            <label for="candidateBureau">Nom du Bureau</label>
                            <input type="text" id="candidateBureau" required placeholder="Ex: Bureau Ex√©cutif">
                        </div>
                        <div class="form-group">
                            <label for="candidateCouleur">Couleur du Bureau</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="color" id="candidateCouleur" value="#3498db" required 
                                       style="width: 60px; height: 40px; border: none; border-radius: 4px; cursor: pointer;">
                                <span id="candidateCouleurText" style="font-size: 14px; color: #666;">#3498db</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="candidatePhoto">Photo du candidat</label>
                        <input type="file" id="candidatePhoto" accept="image/*" required>
                        <img id="candidatePhotoPreview" class="file-preview">
                    </div>                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Ajouter le candidat
                    </button>
                </form>
                <hr style="margin: 2rem 0;">
                <h3><i class="fas fa-list"></i> Candidats actuels</h3>
                <div id="candidatesList"></div>
            </div>
 
            <!-- Contenu Admin: Gestion de l'√©lection -->
            <div id="electionContent" class="admin-content card">
             <h3>Statut de l'√©lection</h3>
             <p>Statut actuel : <strong id="electionStatusAdmin"></strong></p>
             <br>
             <div id="electionControlButtons">
                 <button id="startElectionBtn" class="btn btn-success">
                     <i class="fas fa-play"></i> D√©marrer l'√©lection
                 </button>
                 <button id="stopElectionBtn" class="btn btn-danger">
                     <i class="fas fa-stop"></i> Terminer l'√©lection
                 </button>
                 <button id="resetElectionBtn" class="btn btn-warning">
                     <i class="fas fa-redo"></i> R√©initialiser l'√©lection
                 </button>
             </div>
             
             <!-- Section des statistiques -->
             <div id="electionStats" style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: none;">
                 <h4><i class="fas fa-chart-bar"></i> Statistiques</h4>
                 <div id="statsContent">
                     <!-- Les statistiques seront inject√©es ici -->
                 </div>
             </div>
            </div>

            <!-- Contenu Admin: R√©sultats -->
            <div id="resultsContent" class="admin-content card">
                <h3>R√©sultats de l'√©lection</h3>
                <div id="resultsContainer"></div>
            </div>

            <!-- Contenu Admin: Gestion des utilisateurs -->
            <div id="usersContent" class="admin-content card">
                <h4>Liste des √âtudiants inscrits √† l'AESP</h4>
                <h3>Gestion des √âtudiants</h3>
                <div id="usersList"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 AESP - South Polytech. Tous droits r√©serv√©s.</p>
        </div>
    </footer>

    <script>
        function hideConfirmation(type) {
            if (type === 'success') {
                document.getElementById('successConfirmation').style.display = 'none';
            } else if (type === 'error') {
                console.log("offffffff")
                document.getElementById('errorConfirmation').style.display = 'none';
            }
        }
    document.addEventListener('DOMContentLoaded', () => {
        showLoader('pageLoadLoader');

        // =================================================================
        // √âL√âMENTS DU DOM
        // =================================================================
        const views = document.querySelectorAll('.view');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const registerSuccess = document.getElementById('registerSuccess');
        const logoutButtons = document.querySelectorAll('#logoutBtnPending, #logoutBtnVote, #logoutBtnVoted, #logoutBtnAdmin');
        const studentWelcomeMsg = document.getElementById('studentWelcomeMsg');
        const studentWelcomeVotingMsg = document.getElementById('studentWelcomeVotingMsg');
        const candidatesForVote = document.getElementById('candidatesForVote');
        const electionStatusMessage = document.getElementById('electionStatusMessage');
        const adminNavButtons = document.querySelectorAll('.admin-nav-btn');
        const adminContents = document.querySelectorAll('.admin-content');
        const pendingUsersList = document.getElementById('pendingUsersList');
        const addCandidateForm = document.getElementById('addCandidateForm');
        const candidatesList = document.getElementById('candidatesList');
        const electionStatusAdmin = document.getElementById('electionStatusAdmin');
        const startElectionBtn = document.getElementById('startElectionBtn');
        const stopElectionBtn = document.getElementById('stopElectionBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const usersList = document.getElementById('usersList');
        const photoPreview = document.getElementById('photoPreview');
        const recuPreview = document.getElementById('recuPreview');
        const registerPhoto = document.getElementById('registerPhoto');
        const registerRecu = document.getElementById('registerRecu');
        const loginFormContainer = document.getElementById('loginFormContainer');
        const registerFormContainer = document.getElementById('registerFormContainer');
        const selectedCandidateInfo = document.getElementById('selectedCandidateInfo');
        const selectedCandidateName = document.getElementById('selectedCandidateName');
        const confirmVoteBtn = document.getElementById('confirmVoteBtn');
        const candidatePhotoPreview = document.getElementById('candidatePhotoPreview');
        const candidatePhoto = document.getElementById('candidatePhoto');

        // =================================================================
        // FONCTIONS POUR LES LOADERS
        // =================================================================
        
        function showLoader(loaderId) {
            document.getElementById(loaderId).style.display = 'flex';
        }
        
        function hideLoader(loaderId) {
            document.getElementById(loaderId).style.display = 'none';
        }
        
        function disableButtons(buttons) {
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });
        }
        
        function enableButtons(buttons) {
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        }

        // Remplacer les appels directs aux loaders par cette fonction
        function manageLoaders(action, loaderId = null) {
            const loaders = ['pageLoadLoader', 'loginLoader', 'registerLoader', 'voteLoader', 'registerCandidat', 'deleteCandidat'];
            
            if (action === 'hideAll') {
                loaders.forEach(loader => hideLoader(loader));
            } else if (action === 'show' && loaderId) {
                // Cacher tous les autres loaders avant d'afficher celui demand√©
                loaders.forEach(loader => {
                    if (loader !== loaderId) hideLoader(loader);
                });
                showLoader(loaderId);
            } else if (action === 'hide' && loaderId) {
                hideLoader(loaderId);
            }
        }

        // =================================================================
        // VARIABLES GLOBALES
        // =================================================================
        let selectedCandidateId = null;
        let state = {
            currentUser: null,
            candidates: [],
            electionStatus: 'pending',
            pendingUsers: [],
            allUsers: []
        };

        // Variables pour le rafra√Æchissement automatique
        let refreshInterval = null;
        const REFRESH_INTERVAL = 10000; // 10 secondes
        let lastUpdateTimestamp = Date.now();

        // =================================================================
        // SYST√àME DE RAFRA√éCHISSEMENT AUTOMATIQUE - AJOUTEZ CES FONCTIONS
        // =================================================================

        // Fonction pour d√©marrer le rafra√Æchissement automatique
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                try {
                    await checkForUpdates();
                } catch (error) {
                    console.log('Erreur lors du rafra√Æchissement:', error);
                }
            }, REFRESH_INTERVAL);
            
            console.log('üîÑ Rafra√Æchissement automatique activ√©');
        }
        
        // Fonction pour arr√™ter le rafra√Æchissement automatique
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('‚èπÔ∏è Rafra√Æchissement automatique d√©sactiv√©');
            }
        }
        
        // Fonction pour v√©rifier les mises √† jour
        async function checkForUpdates() {
            try {
                const data = await apiFetch('/api/dashboard_data/');
                const currentTimestamp = Date.now();
                
                // V√©rifier si les donn√©es ont chang√©
                const hasChanges = hasDataChanged(data);
                
                if (hasChanges) {
                    console.log('üîÑ Donn√©es mises √† jour d√©tect√©es');
                    
                    // Mettre √† jour l'√©tat
                    state.currentUser = data.user;
                    state.candidates = data.candidates;
                    state.electionStatus = data.election_status;
                    state.pendingUsers = data.pending_users;
                    state.allUsers = data.all_users;
                    lastUpdateTimestamp = currentTimestamp;
                    
                    // Rafra√Æchir l'interface selon la vue active  checkSession
                    refreshCurrentView();
                }
            } catch (error) {
                console.log('Erreur lors de la v√©rification des mises √† jour:', error);
                // En cas d'erreur, arr√™ter le rafra√Æchissement automatique
                stopAutoRefresh();
            }
        }
        
        // Fonction pour d√©tecter les changements dans les donn√©es
        function hasDataChanged(newData) {
            // V√©rifier les candidats
            if (state.candidates.length !== newData.candidates.length) {
                return true;
            }
            
            // V√©rifier les votes des candidats
            for (let i = 0; i < state.candidates.length; i++) {
                if (state.candidates[i].votes !== newData.candidates[i].votes) {
                    return true;
                }
            }
            
            // V√©rifier le statut de l'√©lection
            if (state.electionStatus !== newData.election_status) {
                return true;
            }
            
            // V√©rifier les utilisateurs en attente
            if (state.pendingUsers.length !== newData.pending_users.length) {
                return true;
            }
            
            // V√©rifier les utilisateurs valid√©s
            if (state.allUsers.length !== newData.all_users.length) {
                return true;
            }
            
            return false;
        }
        
        // Fonction pour rafra√Æchir la vue actuelle
        function refreshCurrentView() {
            const activeView = document.querySelector('.view.active');
            console.log("Je viens dans refreshCurrentView avec activeView = ", activeView)
            if (!activeView) return;
            
            const viewId = activeView.id;
            
            switch(viewId) {
                case 'adminDashboardView':
                    renderAdminDashboard();
                    break;
                    
                case 'studentVoteView':
                    renderStudentVoteView();
                    break;
                    
                case 'studentVotedView':
                    // Juste mettre √† jour le message de bienvenue si n√©cessaire
                    if (state.currentUser) {
                        studentWelcomeVotingMsg.textContent = `Merci √©tudiant(e) ${state.currentUser.prenom} ${state.currentUser.nom} d'avoir vot√© !`;
                    }
                    break;
                    
                case 'studentPendingView':
                    // Pas besoin de rafra√Æchir cette vue
                    break;
                    
                case 'authView':
                    // Pas besoin de rafra√Æchir cette vue
                    break;
            }
            
            // Afficher une notification discr√®te des mises √† jour
            showUpdateNotification();
        }
        
        // Fonction pour afficher une notification de mise √† jour
        function showUpdateNotification() {
            // Cr√©er une notification toast discr√®te
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.innerHTML = '‚úÖ Donn√©es mises √† jour';
            document.body.appendChild(toast);
            
            // Supprimer apr√®s 3 secondes
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Ajouter les animations CSS pour les notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .update-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
            }
        `;
        document.head.appendChild(style);

        // =================================================================
        // GESTION DE LA COULEUR DU BUREAU
        // =================================================================
        
        // √âcouteur pour le changement de couleur
        document.getElementById('candidateCouleur').addEventListener('input', function(e) {
            document.getElementById('candidateCouleurText').textContent = e.target.value;
        });
        
        // Fonction pour g√©n√©rer le badge avec la couleur personnalis√©e
        function getBureauBadge(bureauName, bureauColor) {
            // V√©rifier si la couleur est valide, sinon utiliser une couleur par d√©faut
            const validColor = bureauColor && bureauColor.startsWith('#') ? bureauColor : '#3498db';
            
            return `
                <div class="bureau-badge" style="background: ${validColor};">
                    <i class="fas fa-users"></i>${bureauName || 'Bureau'}
                </div>
            `;
        }
        
        // Fonction pour calculer la luminosit√© d'une couleur (pour d√©terminer la couleur du texte)
        function getColorBrightness(hexColor) {
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            return (r * 299 + g * 587 + b * 114) / 1000;
        }

        // =================================================================
        // FONCTIONS DE CONFIRMATION
        // =================================================================
        function showConfirmation(type, message = '') {
            if (type === 'success') {
                document.getElementById('successConfirmation').style.display = 'flex';
            } else if (type === 'error') {
                if (message) {
                    document.getElementById('errorMessage').textContent = message;
                }
                document.getElementById('errorConfirmation').style.display = 'flex';
            }
        }

        function hideConfirmation(type) {
            if (type === 'success') {
                document.getElementById('successConfirmation').style.display = 'none';
            } else if (type === 'error') {
                document.getElementById('errorConfirmation').style.display = 'none';
            }
        }

        // =================================================================
        // FONCTIONS UTILITAIRES
        // =================================================================
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        async function apiFetch(url, options = {}) {
            options.headers = {
                ...options.headers,
                'X-CSRFToken': csrftoken,
            };
            
            if (!(options.body instanceof FormData)) {
                 options.headers['Content-Type'] = 'application/json';
            }

            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Erreur de communication avec le serveur.' }));
                throw new Error(errorData.error || `Erreur ${response.status}`);
            }
            return response.json();
        }

        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function displayMessage(element, message, type = 'error') {
            element.textContent = message;
            element.className = `message message-${type}`;
            element.style.display = 'block';
        }

        function hideMessage(element) {
            element.style.display = 'none';
        }

        function previewImage(input, previewElement) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewElement.src = e.target.result;
                    previewElement.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        // =================================================================
        // GESTION DE L'AUTHENTIFICATION
        // =================================================================

        showRegister.addEventListener('click', () => {
            loginFormContainer.style.display = 'none';
            registerFormContainer.style.display = 'block';
            hideMessage(loginError);
        });

        showLogin.addEventListener('click', () => {
            registerFormContainer.style.display = 'none';
            loginFormContainer.style.display = 'block';
            hideMessage(registerError);
            hideMessage(registerSuccess);
        });

        registerPhoto.addEventListener('change', () => previewImage(registerPhoto, photoPreview));
        registerRecu.addEventListener('change', () => previewImage(registerRecu, recuPreview));
        candidatePhoto.addEventListener('change', () => previewImage(candidatePhoto, candidatePhotoPreview));

        // Dans votre JavaScript, ajoutez ces fonctions pour g√©rer les d√©pendances
        async function updateSpecialitesByCycle(cycle) {
            const specialiteSelect = document.getElementById('registerSpecialite');
            const niveauSelect = document.getElementById('registerNiveau');
            
            // Vider les options actuelles
            specialiteSelect.innerHTML = '<option value="">S√©lectionnez votre sp√©cialit√©</option>';
            niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
            specialiteSelect.disabled = true;
            niveauSelect.disabled = true;

            if (!cycle) {
                specialiteSelect.innerHTML = '<option value="">S√©lectionnez d\'abord le cycle</option>';
                niveauSelect.innerHTML = '<option value="">S√©lectionnez d\'abord le cycle</option>';
                return;
            }
            
            try {
                // Appel API pour r√©cup√©rer les options
                const response = await fetch(`/api/cycle-options/?cycle=${cycle}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur de chargement');
                }
                
                // Mettre √† jour les sp√©cialit√©s
                specialiteSelect.innerHTML = '<option value="">S√©lectionnez votre sp√©cialit√©</option>';
                data.specialites.forEach(specialite => {
                    const option = document.createElement('option');
                    option.value = specialite[0];  // La valeur (ex: 'informatique_bts')
                    option.textContent = specialite[1];  // Le libell√© (ex: 'Informatique BTS')
                    specialiteSelect.appendChild(option);
                });
                specialiteSelect.disabled = false;
                
                // Mettre √† jour les niveaux si pas ingenieur
                if (cycle != 'ingenieur'){
                    niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
                    data.niveaux.forEach(niveau => {
                        const option = document.createElement('option');
                        option.value = niveau; 
                        option.textContent = niveau;
                        niveauSelect.appendChild(option);
                    });
                    niveauSelect.disabled = false;
                }
                    
            } catch (error) {
                console.error('Erreur:', error);
                specialiteSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                niveauSelect.innerHTML = '<option value="">Erreur de chargement</option>';
            }
        }
        function updateNiveauBySpecialityIng(speciality) {
            const niveauSelect = document.getElementById('registerNiveau');
            let niveauxList  = [];
            // Vider les options actuelles
            niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
            niveauSelect.disabled = true;
            if (!speciality) {
                niveauSelect.innerHTML = '<option value="">S√©lectionnez d\'abord la specialit√©</option>';
                return;
            }
            if (speciality == 'Pr√©pa') { niveauxList  = [1, 2] }
            else { niveauxList  = [3, 4, 5] }
            // Mettre √† jour les sp√©cialit√©s
            niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
            niveauxList.forEach(niveau => {
                const option = document.createElement('option');
                option.value = niveau;  // La valeur (ex: 'informatique_bts')
                option.textContent = niveau;  // Le libell√© (ex: 'Informatique BTS')
                niveauSelect.appendChild(option);
            });
            niveauSelect.disabled = false;
        }

        // √âcouteur pour le changement de cycle
        document.getElementById('registerCycle').addEventListener('change', function(e) {
            updateSpecialitesByCycle(e.target.value);
        });
        // √âcouteur pour le changement de specialit√© ingenieur
        document.getElementById('registerSpecialite').addEventListener('change', function(e) {
            if (document.getElementById('registerCycle').value == "ingenieur"){
                updateNiveauBySpecialityIng(e.target.value);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(registerError);
            hideMessage(registerSuccess);
        
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            if (password !== confirmPassword) {
                displayMessage(registerError, 'Les mots de passe ne correspondent pas.');
                return;
            }
        
            // D√©sactiver le bouton d'inscription
            const submitBtn = registerForm.querySelector('button[type="submit"]');
            disableButtons([submitBtn]);
            showLoader('registerLoader');
        
            const formData = new FormData();
            formData.append('nom', document.getElementById('registerNom').value);
            formData.append('prenom', document.getElementById('registerPrenom').value);
            formData.append('matricule', document.getElementById('registerMatricule').value);
            formData.append('cycle', document.getElementById('registerCycle').value);
            formData.append('specialite', document.getElementById('registerSpecialite').value);
            formData.append('niveau', document.getElementById('registerNiveau').value);
            formData.append('password', password);
            formData.append('photo', registerPhoto.files[0]);
            formData.append('recu', registerRecu.files[0]);
        
            try {
                const data = await apiFetch('/api/register/', { 
                    method: 'POST', 
                    body: formData 
                });
                
                showConfirmation('success');
                registerForm.reset();
                photoPreview.style.display = 'none';
                recuPreview.style.display = 'none';
                hideMessage(registerError);
                hideMessage(registerSuccess);
        
            } catch (error) {
                showConfirmation('error', error.message);
            } finally {
                // R√©activer le bouton et cacher le loader
                enableButtons([submitBtn]);
                hideLoader('registerLoader');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(loginError);
            
            const matricule = document.getElementById('loginMatricule').value;
            const password = document.getElementById('loginPassword').value;
        
            // D√©sactiver le bouton de connexion
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            disableButtons([submitBtn]);
            showLoader('loginLoader');
        
            try {
                const user = await apiFetch('/api/login/', {
                    method: 'POST',
                    body: JSON.stringify({ matricule, password })
                });
                state.currentUser = user;
                loginForm.reset();
                studentWelcomeMsg.textContent = `Bienvenue, ${state.currentUser.prenom} ${state.currentUser.nom}`;
                
                navigateToDashboard();
            } catch (error) {
                displayMessage(loginError, error.message);
            } finally {
                // R√©activer le bouton et cacher le loader
                enableButtons([submitBtn]);
                hideLoader('loginLoader');
            }
        });

        logoutButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                // Arr√™ter le rafra√Æchissement automatique
                stopAutoRefresh();
                
                await apiFetch('/api/logout/');
                state.currentUser = null;
                showView('authView');
            });
        });
        // Ajoutez cette fonction pour g√©rer l'actualisation de la page
        window.addEventListener('beforeunload', function() {
            showLoader('pageLoadLoader');
            console.log("stopAutoRefresh a l'actualisation")
            // Arr√™ter le rafra√Æchissement auto mais NE PAS montrer de loader
            //stopAutoRefresh();
        });
        
        // Et assurez-vous de cacher le loader si la page est recharg√©e
        window.addEventListener('load', function() {
            // Cacher imm√©diatement tous les loaders au chargement
            manageLoaders('hideAll');
        });


        async function checkSession() {
            try {
                const data = await apiFetch('/api/dashboard_data/');
                console.log(data);

                state.currentUser = data.user;
                state.candidates = data.candidates;
                state.electionStatus = data.election_status;
                state.pendingUsers = data.pending_users;
                state.allUsers = data.all_users;
                navigateToDashboard();
                console.log("state.pendingUsers :", state.pendingUsers);
            } catch (error) {
                console.log('Session non valide, affichage login:', error);
                showView('authView');
            } finally {
                // Cacher le loader de chargement page une fois tout charg√©
                hideLoader('pageLoadLoader');
            }
        }

        function navigateToDashboard() {
            if (!state.currentUser) return;
            console.log("stopAutoRefresh a navigateToDashboard")
            
            // Arr√™ter le rafra√Æchissement pr√©c√©dent
            stopAutoRefresh();
        
            if (state.currentUser.is_admin) {
                showView('adminDashboardView');
                renderAdminDashboard();
                // D√©marrer le rafra√Æchissement automatique pour l'admin
                startAutoRefresh();
                console.log("state.currentUser.is_admin")
            } else {
                if (state.currentUser.status === 'pending') {
                    showView('studentPendingView');
                    console.log("state.currentUser.status === 'pending'")
                    // Pas de rafra√Æchissement automatique pour les utilisateurs en attente
                } else if (state.currentUser.status === 'validated') {
                    console.log("state.currentUser.status === 'validated'")
                    if (state.currentUser.has_voted) {
                        studentWelcomeVotingMsg.textContent = `Merci √©tudiant(e) ${state.currentUser.prenom} ${state.currentUser.nom} d'avoir vot√© !`;
                        showView('studentVotedView');
                        // Rafra√Æchissement limit√© pour les utilisateurs ayant vot√©
                        startAutoRefresh();
                        console.log("state.currentUser.has_voted")
                    } else {
                        showView('studentVoteView');
                        renderStudentVoteView();
                        // Rafra√Æchissement actif pour les utilisateurs pouvant voter
                        startAutoRefresh();
                        console.log("state.currentUser.has_voted == False")
                    }
                }
            }
        }
        // =================================================================
        // INTERFACE √âTUDIANT AM√âLIOR√âE
        // =================================================================

        function renderStudentVoteView() {
            studentWelcomeMsg.textContent = `Bienvenue, ${state.currentUser.prenom} ${state.currentUser.nom}`;
            candidatesForVote.innerHTML = '';
            selectedCandidateId = null;
            selectedCandidateInfo.style.display = 'none';
            console.log(state.electionStatus)
            if (state.electionStatus == 'pending') {
                electionStatusMessage.innerHTML = '<div class="message message-warning">L\'√©lection n\'est pas encore ouverte.</div>';
                return;
            }
            if (state.electionStatus == 'closed') {
                electionStatusMessage.innerHTML = '<div class="message message-warning">L\'√©lection est termin√©e !</div>';
                return;
            }
            
            if (state.candidates.length === 0) {
                electionStatusMessage.innerHTML = '<div class="message message-info">Aucun candidat n\'est enregistr√© pour le moment.</div>';
                return;
            }

            state.candidates.forEach(candidate => {
                const candidateDiv = document.createElement('div');
                candidateDiv.className = 'candidate-card';

                // R√©cup√©rer le nom et la couleur du bureau depuis les donn√©es du candidat
                const bureauName = candidate.bureau_name || 'Bureau';
                const bureauColor = candidate.bureau_color || '#3498db';
                const bureauBadge = getBureauBadge(bureauName, bureauColor);


                candidateDiv.innerHTML = `
                    ${bureauBadge}
                    <div class="selection-badge">
                        <i class="fas fa-check"></i> S√©lectionn√©
                    </div>
                    <img src="${candidate.photo_url || 'https://api.dicebear.com/8.x/initials/svg?seed=' + encodeURIComponent(candidate.nom)}" 
                         alt="Photo de ${candidate.prenom} ${candidate.nom}">
                    <h4>${candidate.prenom} ${candidate.nom}</h4>
                    
                    <div class="candidate-info">
                        <p>
                            <i class="fas fa-graduation-cap"></i> 
                            <strong>Cycle:</strong> 
                            <span>${candidate.cycle_display}</span>
                        </p>
                        <p>
                            <i class="fas fa-book"></i> 
                            <strong>Sp√©cialit√©:</strong> 
                            <span>${candidate.specialite_display}</span>
                        </p>
                        <p>
                            <i class="fas fa-layer-group"></i> 
                            <strong>Niveau:</strong> 
                            <span>${candidate.niveau}</span>
                        </p>
                        <p>
                            <i class="fas fa-building"></i> 
                            <strong>Bureau:</strong> 
                            <span>${bureauName}</span>
                        </p>
                    </div>
                    
                    <div class="slogan">
                        <i class="fas fa-quote-left"></i> 
                        ${candidate.slogan || "Ensemble pour l'avenir de l'AESP !"}
                        <i class="fas fa-quote-right"></i>
                    </div>
                    
                    <button class="vote-btn" data-candidate-id="${candidate.id}">
                        <i class="fas fa-vote-yea"></i> Choisir ce candidat
                    </button>
                `;
                candidatesForVote.appendChild(candidateDiv);
            });
        }
        // Gestion de la s√©lection des candidats
        candidatesForVote.addEventListener('click', (e) => {
            if (e.target.classList.contains('vote-btn') || e.target.closest('.vote-btn')) {
                const voteBtn = e.target.classList.contains('vote-btn') ? e.target : e.target.closest('.vote-btn');
                const candidateId = parseInt(voteBtn.dataset.candidateId);
                
                // D√©s√©lectionner toutes les cartes
                document.querySelectorAll('.candidate-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // S√©lectionner la carte cliqu√©e
                const selectedCard = voteBtn.closest('.candidate-card');
                selectedCard.classList.add('selected');
                
                // Mettre √† jour la s√©lection
                selectedCandidateId = candidateId;
                const candidate = state.candidates.find(c => c.id === candidateId);
                selectedCandidateName.textContent = `${candidate.prenom} ${candidate.nom}`;
                selectedCandidateInfo.style.display = 'block';
                
                // Scroll vers le haut pour voir la confirmation
                selectedCandidateInfo.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Confirmation du vote
        confirmVoteBtn.addEventListener('click', async () => {
            if (!selectedCandidateId) {
                alert('Veuillez s√©lectionner un candidat avant de voter.');
                return;
            }
        
            if (confirm(`√ätes-vous s√ªr de vouloir voter pour ${selectedCandidateName.textContent} ?\n\nCette action est irr√©versible et vous ne pourrez plus modifier votre choix.`)) {
                await castVote(selectedCandidateId);
            }
        });

        async function castVote(candidateId) {
            // D√©sactiver tous les boutons de vote
            const voteButtons = document.querySelectorAll('.vote-btn');
            const confirmBtn = document.getElementById('confirmVoteBtn');
            disableButtons([...voteButtons, confirmBtn]);
            showLoader('voteLoader');
        
            try {
                await apiFetch('/api/vote/', {
                    method: 'POST',
                    body: JSON.stringify({ candidate_id: candidateId })
                });
                await checkSession();
            } catch (error) {
                alert(`Erreur lors du vote : ${error.message}`);
            } finally {
                // R√©activer les boutons et cacher le loader
                enableButtons([...voteButtons, confirmBtn]);
                hideLoader('voteLoader');
            }
        }

        // =================================================================
        // INTERFACE ADMINISTRATEUR AM√âLIOR√âE
        // =================================================================

        function renderAdminDashboard() {
            switchAdminTab('validationContent');
            renderPendingUsers();
            renderCandidatesList();
            renderElectionStatus();
            renderResults();
            renderUsersList();
        }
        
        adminNavButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                switchAdminTab(btn.dataset.target);
            });
        });

        function switchAdminTab(targetId) {
            // D√©sactiver tous les contenus
            adminContents.forEach(content => content.classList.remove('active'));
            // D√©sactiver tous les boutons
            adminNavButtons.forEach(btn => btn.classList.remove('active'));            
            // Activer le contenu cible
            document.getElementById(targetId).classList.add('active');            
            // Activer le bouton correspondant
            const activeButton = Array.from(adminNavButtons).find(btn => 
                btn.dataset.target === targetId            );
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        function renderPendingUsers() {
            pendingUsersList.innerHTML = '';
            if (state.pendingUsers.length === 0) {
                pendingUsersList.innerHTML = '<p>Aucun utilisateur en attente de validation.</p>';
                return;
            }

            state.pendingUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'list-item';
                userDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
                    <a href="${user.photo_url}" target="_blank" style="color: var(--secondary-color); text-decoration: none;">
                        <img src="${user.photo_url || 'https://api.dicebear.com/8.x/initials/svg?seed=' + encodeURIComponent(user.prenom + ' ' + user.nom)}" 
                         alt="Photo de ${user.prenom} ${user.nom}"
                         style="width: 80px; height: 80px; border-radius: 30%; object-fit: cover; border: 2px solid var(--primary-color);">
                    </a>
                    <div>
                        <strong>${user.prenom} ${user.nom}</strong> (${user.matricule})<br>
                        <strong>${user.cycle}-${user.specialite} ${user.niveau}</strong><br>
                        <a href="${user.recu_url}" target="_blank" style="color: var(--secondary-color); text-decoration: none;">
                            <i class="fas fa-file-invoice"></i> Voir le re√ßu
                        </a>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" data-user-id="${user.id}">
                        <i class="fas fa-check"></i> Valider
                    </button>
                    <button class="btn btn-danger" data-user-id="${user.id}">
                        <i class="fas fa-times"></i> Supprimer
                    </button>
                </div>
            `;
                pendingUsersList.appendChild(userDiv);
            });
        }

        pendingUsersList.addEventListener('click', async (e) => {
            console.log("appuy√© !!!!")
            if (e.target.tagName !== 'BUTTON') return;
            const userId = e.target.dataset.userId;
            if (!userId) return;

            try {
                if (e.target.classList.contains('btn-success')) {
                    await apiFetch(`/api/users/${userId}/`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'validated' })
                    });
                } else if (e.target.classList.contains('btn-danger')) {
                    if (confirm("√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?")) {
                        await apiFetch(`/api/users/${userId}/`, { method: 'DELETE' });
                    }
                }
                await checkSession();
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }
        });
        usersList.addEventListener('click', async (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const userId = e.target.dataset.userId;
            if (!userId) return;

            try {
                if (e.target.classList.contains('btn-danger')) {
                    if (confirm("√ätes-vous s√ªr de vouloir desactiver cet √©tudiant ?")) {
                        await apiFetch(`/api/users/${userId}/`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'pending' })
                        });
                    }
                } else if (e.target.classList.contains('btn-danger')) {
                    if (confirm("√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?")) {
                        await apiFetch(`/api/users/${userId}/`, { method: 'DELETE' });
                    }
                }
                await checkSession();
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }
        });
        
        // Formulaire d'ajout de candidat am√©lior√©
        // fonctions pour g√©rer les d√©pendances entre cycle et specialit√© niveau
        async function updateSpecialitesCandidatesByCycle(cycle) {
            const specialiteSelect = document.getElementById('candidateSpecialite');
            const niveauSelect = document.getElementById('candidateNiveau');
            
            // Vider les options actuelles
            specialiteSelect.innerHTML = '<option value="">S√©lectionnez votre sp√©cialit√©</option>';
            niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
            specialiteSelect.disabled = true;
            niveauSelect.disabled = true;

            if (!cycle) {
                specialiteSelect.innerHTML = '<option value="">S√©lectionnez d\'abord le cycle</option>';
                niveauSelect.innerHTML = '<option value="">S√©lectionnez d\'abord le cycle</option>';
                return;
            }
            
            try {
                // Appel API pour r√©cup√©rer les options
                const response = await fetch(`/api/cycle-options/?cycle=${cycle}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur de chargement');
                }
                
                // Mettre √† jour les sp√©cialit√©s
                specialiteSelect.innerHTML = '<option value="">S√©lectionnez votre sp√©cialit√©</option>';
                data.specialites.forEach(specialite => {
                    const option = document.createElement('option');
                    option.value = specialite[0];  // La valeur (ex: 'informatique_bts')
                    option.textContent = specialite[1];  // Le libell√© (ex: 'Informatique BTS')
                    specialiteSelect.appendChild(option);
                });
                specialiteSelect.disabled = false;
                
                // Mettre √† jour les niveaux si pas ingenieur
                if (cycle != 'ingenieur'){
                    niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
                    data.niveaux.forEach(niveau => {
                        const option = document.createElement('option');
                        option.value = niveau; 
                        option.textContent = niveau;
                        niveauSelect.appendChild(option);
                    });
                    niveauSelect.disabled = false;
                }
                    
            } catch (error) {
                console.error('Erreur:', error);
                specialiteSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                niveauSelect.innerHTML = '<option value="">Erreur de chargement</option>';
            }
        }
        function updateNiveauCandidatesBySpecialityIng(speciality) {
            const niveauSelect = document.getElementById('candidateNiveau');
            let niveauxList  = [];
            // Vider les options actuelles
            niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
            niveauSelect.disabled = true;

            if (!speciality) {
                niveauSelect.innerHTML = '<option value="">S√©lectionnez d\'abord la specialit√©</option>';
                return;
            }
            if (speciality == 'Pr√©pa') { niveauxList  = [1, 2] }
            else { niveauxList  = [3, 4, 5] }
            // Mettre √† jour les sp√©cialit√©s
            niveauSelect.innerHTML = '<option value="">S√©lectionnez votre niveau</option>';
            niveauxList.forEach(niveau => {
                const option = document.createElement('option');
                option.value = niveau;  // La valeur (ex: 'informatique_bts')
                option.textContent = niveau;  // Le libell√© (ex: 'Informatique BTS')
                niveauSelect.appendChild(option);
            });
            niveauSelect.disabled = false;
        }

        // √âcouteur pour le changement de cycle
        document.getElementById('candidateCycle').addEventListener('change', function(e) {
            updateSpecialitesCandidatesByCycle(e.target.value);
        });
        // √âcouteur pour le changement de SPECIALITE
        document.getElementById('candidateSpecialite').addEventListener('change', function(e) {
            if (document.getElementById('candidateCycle').value == "ingenieur"){
                updateNiveauCandidatesBySpecialityIng(e.target.value);
            }
        });
        addCandidateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (state.electionStatus === 'active') {
                alert("Vous ne pouvez pas ajouter un candidat pendant une √©lection active.");
                return;
            }
            // D√©sactiver le bouton d'ajout de candidat
            const submitBtn = registerForm.querySelector('button[type="submit"]');
            disableButtons([submitBtn]);
            showLoader('registerCandidat');
            
            const nom = document.getElementById('candidateNom').value.trim();
            const prenom = document.getElementById('candidatePrenom').value.trim();
            const cycle = document.getElementById('candidateCycle').value;
            const specialite = document.getElementById('candidateSpecialite').value.trim();
            const niveau = document.getElementById('candidateNiveau').value;
            const slogan = document.getElementById('candidateSlogan').value.trim();
            const bureau = document.getElementById('candidateBureau').value.trim();
            const couleur = document.getElementById('candidateCouleur').value;

            if (!nom || !prenom || !cycle || !specialite || !niveau || !slogan || !bureau || !couleur) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            const formData = new FormData();
            formData.append('nom', nom);
            formData.append('prenom', prenom);
            formData.append('cycle', cycle);
            formData.append('specialite', specialite);
            formData.append('niveau', niveau);
            formData.append('slogan', slogan);
            formData.append('bureau_name', bureau);
            formData.append('bureau_color', couleur);
            formData.append('photo', candidatePhoto.files[0]);

            try {
                await apiFetch('/api/candidates/', {
                    method: 'POST',
                    body: formData
                });
                
                addCandidateForm.reset();
                candidatePhotoPreview.style.display = 'none';
                // R√©initialiser la couleur
                document.getElementById('candidateCouleur').value = '#3498db';
                document.getElementById('candidateCouleurText').textContent = '#3498db';
                await checkSession();
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }finally {
                // R√©activer le bouton et cacher le loader
                enableButtons([submitBtn]);
                hideLoader('registerCandidat');
            }
        });

        function renderCandidatesList() {
            candidatesList.innerHTML = '';
            if (state.candidates.length === 0) {
                candidatesList.innerHTML = '<p>Aucun candidat enregistr√©.</p>';
                return;
            }
            state.candidates.forEach(candidate => {
                const candidateDiv = document.createElement('div');
                candidateDiv.className = 'list-item';
                
                const bureauColor = candidate.bureau_color || '#3498db';
                const bureauName = candidate.bureau_name || 'Bureau';
                
                candidateDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
                        <a href="${candidate.photo_url}" target="_blank" style="color: var(--secondary-color); text-decoration: none;">
                            <img src="${candidate.photo_url || 'https://api.dicebear.com/8.x/initials/svg?seed=' + encodeURIComponent(candidate.prenom + ' ' + candidate.nom)}" 
                             alt="Photo de ${candidate.prenom} ${candidate.nom}"
                             style="width: 80px; height: 80px; border-radius: 30%; object-fit: cover; border: 2px solid var(--primary-color);">
                        </a>
                        <div style="flex-grow: 1;">
                            <strong>${candidate.prenom} ${candidate.nom}</strong><br>
                            <small>${candidate.cycle_display} - ${candidate.specialite} ${candidate.niveau}</small><br>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                <div style="width: 16px; height: 16px; border-radius: 50%; background: ${bureauColor}; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                                <span style="font-size: 0.85rem; color: #666;">${bureauName}</span>
                            </div>
                            <small>"${candidate.slogan}"</small><br>
                            <span style="color: var(--success-color); font-weight: bold;">
                                ${candidate.votes} vote(s)
                            </span>
                        </div>
                    </div>
                    <button class="btn btn-danger" data-candidate-id="${candidate.id}">Supprimer</button>
                `;
                candidatesList.appendChild(candidateDiv);
            });
        }
        candidatesList.addEventListener('click', async (e) => {
             if (e.target.tagName !== 'BUTTON' || !e.target.dataset.candidateId) return;
             if (state.electionStatus === 'active') {
                 alert("Vous ne pouvez pas supprimer un candidat pendant une √©lection active.");
                 return;
             }
             if (confirm("√ätes-vous s√ªr de vouloir supprimer ce candidat ?")) {
                try {
                    showLoader('deleteCandidat');
                    await apiFetch(`/api/candidates/${e.target.dataset.candidateId}/`, { method: 'DELETE' });
                    await checkSession();
                } catch (error) {
                    alert(`Erreur : ${error.message}`);
                }finally {
                    hideLoader('deleteCandidat');
                }
             }
        });

        // 
        function renderElectionStatus() {
            const statusText = { 
                pending: "üü° En attente", 
                active: "üü¢ Active", 
                closed: "üî¥ Termin√©e" 
            };
            electionStatusAdmin.textContent = statusText[state.electionStatus];
            
            // Afficher/masquer les boutons selon le statut
            startElectionBtn.style.display = state.electionStatus === 'pending' ? 'flex' : 'none';
            stopElectionBtn.style.display = state.electionStatus === 'active' ? 'flex' : 'none';
            resetElectionBtn.style.display = state.electionStatus === 'closed' ? 'flex' : 'none';
            
            // Afficher les statistiques si l'√©lection est termin√©e
            const electionStats = document.getElementById('electionStats');
            if (state.electionStatus === 'closed') {
                electionStats.style.display = 'block';
                renderElectionStats();
            } else {
                electionStats.style.display = 'none';
            }
        }

        // Fonction pour afficher les statistiques
        function renderElectionStats() {
            const statsContent = document.getElementById('statsContent');
            const totalVotes = state.candidates.reduce((sum, candidate) => sum + candidate.votes, 0);
            const totalVoters = state.allUsers.filter(user => user.has_voted).length;
            const totalUsers = state.allUsers.filter(user => user.status === 'validated').length;
            const participationRate = totalUsers > 0 ? ((totalVoters / totalUsers) * 100).toFixed(1) : 0;
            
            statsContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${totalVotes}</div>
                        <div class="stat-label">Votes totaux</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalUsers}</div>
                        <div class="stat-label">√âlecteurs inscrits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${participationRate}%</div>
                        <div class="stat-label">Taux de participation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${state.candidates.length}</div>
                        <div class="stat-label">Candidats</div>
                    </div>
                </div>
                
                <div class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Attention :</strong> La r√©initialisation effacera tous les votes et remettra l'√©lection √† z√©ro.
                </div>
            `;
        }

        // Gestionnaire pour le bouton de r√©initialisation
        resetElectionBtn.addEventListener('click', async () => {
            if (!confirm(`üö® ACTION IRR√âVERSIBLE üö®\n\n√ätes-vous ABSOLUMENT s√ªr de vouloir r√©initialiser l'√©lection ?\n\nCette action va :\n‚Ä¢ Remettre tous les compteurs de votes √† z√©ro\n‚Ä¢ R√©initialiser le statut "a vot√©" pour tous les utilisateurs\n‚Ä¢ Remettre l'√©lection en statut "En attente"\n\nCette action ne peut pas √™tre annul√©e !`)) {
                return;
            }
            
            // Demander une confirmation suppl√©mentaire
            const confirmation = prompt(`Pour confirmer la r√©initialisation, tapez "RESET" ci-dessous :`);
            if (confirmation !== 'RESET') {
                alert('R√©initialisation annul√©e. Le texte de confirmation ne correspond pas.');
                return;
            }
            
            try {
                await apiFetch('/api/election/reset/', {
                    method: 'POST',
                    body: JSON.stringify({ confirm: true })
                });
                await checkSession();
                alert('‚úÖ √âlection r√©initialis√©e avec succ√®s !');
            } catch (error) {
                alert(`‚ùå Erreur lors de la r√©initialisation : ${error.message}`);
            }
        });
        
        // Mettez √† jour les autres gestionnaires pour qu'ils utilisent flex
        startElectionBtn.addEventListener('click', () => {
            if (state.candidates.length < 2) {
                alert("Il doit y avoir au moins deux candidats pour d√©marrer l'√©lection.");
                return;
            }
            
            if (confirm("√ätes-vous s√ªr de vouloir d√©marrer l'√©lection ?\n\nLes √©tudiants pourront commencer √† voter.")) {
                updateElectionStatus('active');
            }
        });

        stopElectionBtn.addEventListener('click', () => {
            if (confirm("√ätes-vous s√ªr de vouloir terminer l'√©lection ?\n\nAucun vote ne pourra plus √™tre effectu√©.")) {
                updateElectionStatus('closed');
            }
        });
        
        async function updateElectionStatus(newStatus) {
            if (!confirm(`√ätes-vous s√ªr de vouloir ${newStatus === 'active' ? 'd√©marrer' : 'terminer'} l'√©lection ?`)) return;
            try {
                await apiFetch('/api/election/', {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                await checkSession();
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }
        }

        startElectionBtn.addEventListener('click', () => {
            if (state.candidates.length < 2) {
                alert("Il doit y avoir au moins deux candidats pour d√©marrer l'√©lection.");
                return;
            }
            updateElectionStatus('active');
        });
        stopElectionBtn.addEventListener('click', () => updateElectionStatus('closed'));

        function renderResults() {
            resultsContainer.innerHTML = '';
            if (state.electionStatus === 'pending') {
                resultsContainer.innerHTML = '<div class="message message-info">L\'√©lection n\'a pas encore commenc√©.</div>';
                return;
            }
            
            if (state.candidates.length === 0) {
                resultsContainer.innerHTML = '<div class="message message-info">Aucun candidat enregistr√©.</div>';
                return;
            }

            const totalVotes = state.candidates.reduce((sum, candidate) => sum + candidate.votes, 0);
            
            state.candidates.forEach(candidate => {
                const percentage = totalVotes > 0 ? (candidate.votes / totalVotes) * 100 : 0;
                const candidateDiv = document.createElement('div');
                candidateDiv.className = 'list-item';
                candidateDiv.innerHTML = `
                    <div style="flex-grow: 1;">
                        <a href="${candidate.photo_url}" target="_blank" style="color: var(--secondary-color); text-decoration: none;">
                            <img src="${candidate.photo_url || 'https://api.dicebear.com/8.x/initials/svg?seed=' + encodeURIComponent(user.prenom + ' ' + user.nom)}" 
                             alt="Photo de ${candidate.prenom} ${candidate.nom}"
                             style="width: 80px; height: 80px; border-radius: 30%; object-fit: cover; border: 2px solid var(--primary-color);">
                        </a>
                        <strong>${candidate.prenom} ${candidate.nom}</strong>
                        <div class="result-bar-container">
                            <div class="result-bar" style="width: ${percentage}%">
                                ${candidate.votes} vote(s) (${percentage.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(candidateDiv);
            });
        }

        function renderUsersList() {
            usersList.innerHTML = '';
            if (state.allUsers.length === 0) {
                usersList.innerHTML = '<p>Aucun utilisateur enregistr√©.</p>';
                return;
            }
            // Afficher le nombre total d'inscrits
            const countDiv = document.createElement('div');
            countDiv.className = 'list-item';
            countDiv.innerHTML = `
                <div><h4>Total des inscrits : ${state.allUsers.length-state.pendingUsers.length}</h4></div>
                <div><h4>Total en attente : ${state.pendingUsers.length}</h4></div>
            `;
            usersList.appendChild(countDiv);
            
            // Afficher la liste des Etudiants
            state.allUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'list-item';
                userDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
                        <a href="${user.photo_url}" target="_blank" style="color: var(--secondary-color); text-decoration: none;">
                            <img src="${user.photo_url || 'https://api.dicebear.com/8.x/initials/svg?seed=' + encodeURIComponent(user.prenom + ' ' + user.nom)}" 
                             alt="Photo de ${user.prenom} ${user.nom}"
                             style="width: 80px; height: 80px; border-radius: 30%; object-fit: cover; border: 2px solid var(--primary-color);">
                        </a>
                        <div>
                            <strong>${user.prenom} ${user.nom}</strong> (${user.matricule})<br>
                            <strong>${user.cycle_display} - ${user.specialite} ${user.niveau}</strong><br>
                            <span class="status-${user.status}">${user.status === 'pending' ? 'En attente' : 'Valid√©'}</span>
                            ${user.status === 'pending' ? ' - ‚ùå Ne pas voter': user.has_voted ? ' - ‚úÖ A vot√©' : ' - ‚ùå N\'a pas vot√©'}
                        </div>
                    </div>
                    
                `;
                console.log(user.status)
                console.log(user.status === 'validated')
                if(user.status === 'validated' ){
                    userDiv.innerHTML += `
                        <button class="btn btn-danger" data-user-id="${user.id}">
                            <i class="fas fa-times"></i> Desactiver
                        </button>
                    `;
                }
                usersList.appendChild(userDiv);
            });
        }

        // =================================================================
        // INITIALISATION
        // =================================================================
        console.log('üöÄ D√©marrage de l application');
        checkSession();

    });
    </script>

</body>
</html>